
from fastapi import APIRouter, Depends
from setezor.dependencies.project import get_current_project
from cpeguess.cpeguess import CPEGuess
from setezor.api.dependencies import UOWDep
from setezor.services.vulnerability_service import VulnerabilityService


router = APIRouter(
    prefix="/vulnerability",
    tags=["Vulnerability"],
)

@router.get("/cpe")
async def get_cpe_by_name_and_version(
    vendor: str,
    product: str,
    version: str,
    mode: str = "off",
    project_id: str = Depends(get_current_project)
) -> list:
    guesser = CPEGuess.search(product=product, vendor=vendor, version=version, exact=(mode=="on"))
    if not guesser:
        guesser.append("CPE not found")
    return guesser

@router.get("/search_vulns")
async def get_data_from_search_vulns(
    query: str,
    uow: UOWDep,
    project_id: str = Depends(get_current_project),
):
    return await VulnerabilityService.get_data_from_search_vulns(uow=uow, project_id=project_id, query=query)
