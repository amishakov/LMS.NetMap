
from fastapi import APIRouter, Depends
from setezor.dependencies.project import get_current_project, role_required
from cpeguess.cpeguess import CPEGuess

from setezor.dependencies.uow_dependency import UOWDep
from setezor.managers.project_manager.project_manager import ProjectManager
from setezor.modules.search_vulns.search_vulns import SearchVulns
from setezor.schemas.roles import Roles


router = APIRouter(
    prefix="/vulnerability",
    tags=["Vulnerability"],
)

@router.get("/cpe")
async def get_cpe_by_name_and_version(
    vendor: str,
    product: str,
    version: str,
    mode: str = "off",
    project_id: str = Depends(get_current_project),
    _: bool = Depends(role_required([Roles.owner, Roles.executor, Roles.viewer]))
) -> list:
    guesser = CPEGuess.search(product=product, vendor=vendor, version=version, exact=(mode=="on"))
    if not guesser:
        guesser.append("CPE not found")
    return guesser


@router.get("/search_vulns")
async def get_data_from_search_vulns(
    query: str,
    uow: UOWDep,
    project_id: str = Depends(get_current_project),
) -> dict:
    project = await ProjectManager.get_by_id(uow=uow, project_id=project_id)
    token = project.search_vulns_token
    return await SearchVulns.find(token=token, query_string=query)