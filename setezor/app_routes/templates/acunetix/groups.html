{% macro show() %}
<div class="p-3">
    <button class="btn btn-primary mt-1" id="updateGroups" data-bs-toggle="tooltip" data-bs-toggle="top"
        title="Update groups" onclick="groups_table.dataLoader.reloadData()"><i
            class="bi bi-arrow-clockwise"></i></button>
    <div class="d-flex flex-column mt-2">
        <div class="d-flex">
            <div>
                <div id="groups_table">
                </div>
            </div>
            <div class="ms-1">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addGroup"
                    onclick="document.getElementById('groupAddForm').reset()">Add Group</button>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="addGroup" tabindex="-1" aria-labelledby="addGroupLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupLabel">Adding group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="add_group(event)" id="groupAddForm">
                <div class="modal-body">
                    <input type="text" class="form-control mt-1" name="name" required placeholder="Group Name">
                    <input type="text" class="form-control mt-1" name="description" placeholder="Description">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel_adding"
                        data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Add</button>
                </div>
            </form>

        </div>
    </div>
</div>


<link href="/static/css/tabulator.min.css" rel="stylesheet" type="text/css" />
<link href="/static/css/tabulator_bootstrap4.min.css" rel="stylesheet">
<script src="/static/js/tabulator.min.js" type="text/javascript"></script>
<script>
    var headerMenu = function () {
        var menu = [];
        var columns = this.getColumns();
        for (let column of columns) {
            if (column.getDefinition().field) {
                let icon = document.createElement("i");
                icon.classList.add("bi");
                icon.classList.add(column.isVisible() ? "bi-check-square" : "bi-square");
                let label = document.createElement("span");
                let title = document.createElement("span");
                title.textContent = " " + column.getDefinition().title;
                label.appendChild(icon);
                label.appendChild(title);
                menu.push({
                    label: label,
                    action: function (e) {
                        e.stopPropagation();
                        column.toggle();
                        if (column.isVisible()) {
                            icon.classList.remove("bi-square");
                            icon.classList.add("bi-check-square");
                        } else {
                            icon.classList.remove("bi-check-square");
                            icon.classList.add("bi-square");
                        }
                        { { groups_tab.name } } _table.redraw()
                    }
                });
            }
        }
        return menu;
    }


    function groups_buttons_formatter(cell, formatterParams, onRendered) {
        return `<button class='btn btn-primary btn-sm' id="{{groups_tab.name}}-scan-${cell.getRow().getData().group_id}" 
                        data-bs-toggle="modal" data-bs-target="#addScan"
                        onclick="document.getElementById('scanAddForm').reset();
                        document.getElementById('acunetix_scan_target_id').value='';
                        document.getElementById('acunetix_scan_target_db_id').value='';
                        document.getElementById('acunetix_scan_interval_div').style.display='';
                        document.getElementById('scan_interval').required = true;
                        document.getElementById('acunetix_scan_ports').style.display='none';
                        document.getElementById('acunetix_scan_group_id').value='${cell.getRow().getData().group_id}'">Scan</button>
                        <button class='btn btn-secondary btn-sm' id="{{groups_tab.name}}-target-${cell.getRow().getData().group_id}"
                        data-bs-toggle="modal" data-bs-target="#addTarget"
                        onclick="document.getElementById('targetAddForm').reset();
                        document.getElementById('acunetix_target_group_id').value='${cell.getRow().getData().group_id}'">Add target</button>
                        `;
    }
    function groups_targets_formatter(cell,formatterParams,onRendered){
        return `
        <textarea disabled id="{{groups_tab.name}}-targets-${cell.getRow().getData().group_id}">${cell.getRow().getData().targets}</textarea>
        `;
    }
    var groups_table = new Tabulator('#groups_table', {
        layout: "fitData",
        ajaxURL: "{{groups_tab.base_url}}",

        ajaxURLGenerator: function (url, config, params) {
            //url - the url from the ajaxURL property or setData function
            //config - the request config object from the ajaxConfig property
            //params - the params object from the ajaxParams property, this will also include any pagination, filter and sorting properties based on table setup
            //return request url
            return url + "?params=" + encodeURI(JSON.stringify(params)); //encode parameters as a json object
        },
        selectable: false,
        sortMode: "remote",
        filterMode: "remote",
        pagination: true,
        paginationMode: "remote",
        paginationSize: 5,
        paginationInitialPage: 1,
        paginationSizeSelector: [5, 10, 25, 50, 100],
        columns: [
            {% for col in groups_tab.columns %}
        {{ '{'}}title: "{{col.title}}", field: "{{col.field}}",
        {% if col.headerSort == False %}
    headerSort: false,
        {% endif %}
    headerMenu: headerMenu},
    {% endfor %}
    { title: "Targets", formatter: groups_targets_formatter, headerSort: false },
    { title: "Actions", formatter: groups_buttons_formatter, headerSort: false }
    
        ]
}
)
    groups_table.on("dataLoadError",function (error){
        document.getElementById("acunetix_groups_pill").style.display = 'none';
    })
    async function add_group(event) {
        event.preventDefault();
        let payload = new FormData(event.target);
        resp = await fetch('/api/acunetix/groups/', { method: 'post', body: JSON.stringify(Object.fromEntries(payload)) })
        if (resp.status === 201) {
            document.getElementById("cancel_adding").click();
            groups_table.dataLoader.reloadData();
        }
    }

</script>
{% endmacro %}