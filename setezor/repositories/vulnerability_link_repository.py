from setezor.models import VulnerabilityLink, L7SoftwareVulnerability, Vulnerability, L7Software, L4SoftwareVulnerability, L4Software
from setezor.repositories import SQLAlchemyRepository
from sqlmodel import select

class VulnerabilityLinkRepository(SQLAlchemyRepository[VulnerabilityLink]):
    model = VulnerabilityLink

    async def exists(self, vulnerability_link_obj: VulnerabilityLink):
        return False


    async def all_on_l7(self, project_id: str, l7_id: str):
        stmt = select(Vulnerability.id, VulnerabilityLink.link).select_from(L7Software)\
                .join(L7SoftwareVulnerability, L7SoftwareVulnerability.l7_software_id == L7Software.id)\
                .join(Vulnerability, Vulnerability.id == L7SoftwareVulnerability.vulnerability_id)\
                .join(VulnerabilityLink, VulnerabilityLink.vulnerability_id == Vulnerability.id)\
                .filter(L7Software.project_id ==  project_id, L7Software.l7_id == l7_id)
        res = await self._session.exec(stmt)
        return res.all()


    async def all_on_l4(self, project_id: str, l4_id: str):
        stmt = select(Vulnerability.id, VulnerabilityLink.link).select_from(L4Software)\
                .join(L4SoftwareVulnerability, L4SoftwareVulnerability.l4_software_id == L4Software.id)\
                .join(Vulnerability, Vulnerability.id == L4SoftwareVulnerability.vulnerability_id)\
                .join(VulnerabilityLink, VulnerabilityLink.vulnerability_id == Vulnerability.id)\
                .filter(L4Software.project_id ==  project_id, L4Software.l4_id == l4_id)
        res = await self._session.exec(stmt)
        return res.all()