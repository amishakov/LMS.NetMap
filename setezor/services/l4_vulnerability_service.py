
from setezor.interfaces.service import IService
from setezor.unit_of_work.unit_of_work import UnitOfWork
from setezor.models.l4_software_vulnerability_screenshot import L4SoftwareVulnerabilityScreenshot
from setezor.settings import PROJECTS_DIR_PATH
import base64


class L4VulnerabilityService(IService):
    @classmethod
    async def set_status(cls, uow: UnitOfWork, id:int, status: str, project_id: str) -> list[dict]:
        async with uow:
            status = await uow.l4_software_vulnerability.edit_one(id=id, data={"confirmed":status})
            await uow.commit()
            vuln = await uow.l4_software_vulnerability.find_one(id=id)
        return vuln.confirmed


    @classmethod
    async def get_screenshots(cls, uow: UnitOfWork, project_id: str, scan_id: str, vuln_id: str) -> list[dict]:
        async with uow:
            screenshot_objs = [obj for obj in await uow.l4_software_vulnerability_screenshot.filter(project_id=project_id, scan_id=scan_id, l4_software_vulnerability_id=vuln_id) if not obj.deleted_at]
        result = []
        for screenshot in screenshot_objs:
            result.append({
                "id" : screenshot.id,
                "note" : screenshot.note })
        return result


    @classmethod
    async def add_screenshot(cls, uow: UnitOfWork, project_id: str, scan_id: str, vuln_id: str, data: dict) -> int:
        screenshot_data = base64.b64decode(data.get("file").split(",")[1])
        save_path = f"{PROJECTS_DIR_PATH}/{project_id}/{scan_id}/screenshots/{data.get("filename")}"
        with open(save_path, 'wb') as file:
            file.write(screenshot_data)
        async with uow:
            new_obj = L4SoftwareVulnerabilityScreenshot(project_id=project_id, scan_id=scan_id, l4_software_vulnerability_id=vuln_id, note=data.get("note"), path=save_path)
            uow.l4_software_vulnerability_screenshot.add(data=new_obj.model_dump())
            await uow.commit()
            screenshot_objs = [obj for obj in await uow.l4_software_vulnerability_screenshot.filter(project_id=project_id, scan_id=scan_id, l4_software_vulnerability_id=vuln_id) if not obj.deleted_at]

        return len(screenshot_objs)


    @classmethod
    async def delete_screenshot(cls, uow: UnitOfWork, project_id: str, scan_id: str, id: str) -> int:
        async with uow:
            delete_obj = await uow.l4_software_vulnerability_screenshot.find_one(project_id=project_id, scan_id=scan_id, id=id)
            await uow.l4_software_vulnerability_screenshot.delete(id=id)
            await uow.commit()
            screenshot_objs = [obj for obj in await uow.l4_software_vulnerability_screenshot.filter(project_id=project_id, scan_id=scan_id, l4_software_vulnerability_id=delete_obj.l4_software_vulnerability_id) if not obj.deleted_at]
        return len(screenshot_objs)


    @classmethod
    async def get_screenshot(cls, uow: UnitOfWork, project_id: str, scan_id: str, id: str) -> bytes:
        async with uow:
            screenshot_obj = await uow.l4_software_vulnerability_screenshot.find_one(project_id=project_id, scan_id=scan_id, id=id)
        with open(screenshot_obj.path, 'rb') as file:
            return file.read()
