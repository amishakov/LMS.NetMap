import json

from typing import List
from setezor.managers.websocket_manager import WS_MANAGER
from setezor.modules.search_vulns.search_vulns import SearchVulns
from setezor.schemas.task import TaskStatus, WebSocketMessage
from setezor.interfaces.service import IService
from setezor.unit_of_work.unit_of_work import UnitOfWork
from setezor.models import Task

class VulnerabilityService(IService):
    @classmethod
    async def get_data_from_search_vulns(cls, uow: UnitOfWork, project_id: str, query: str):
        async with uow:
            project = await uow.project.find_one(id=project_id)
        result = await SearchVulns.find(token=project.search_vulns_token, query_string=query)
        for k in result.keys():
            data = result.get(k, [])
            vulns = data.get("vulns")
            result_vulns = dict()
            for key in vulns.keys():
                if vulns[key].get("exploits"):
                    result_vulns.update({key: vulns[key]})
            data["vulns"] = result_vulns

        return result